from flask import Blueprint
from time import time
from os import getenv
from controllers.get_cves import GetCVES

# cache TTL - const of 2 hours in seconds
TTL = float(getenv('TTL'))
cache = {}
get = Blueprint('get', __name__)


# This function handles "get" API to query about CVEs related to a particular vendor's product
@get.route('/task/api/v1.0/get/<string:vendor>/<string:product>', methods=['GET'])
def get_cves(vendor, product):
    query_name = f'{vendor}_{product}'
    if query_name in cache:
        if time() - cache[query_name]['timestamp'] < TTL:
            return {'data': {'vendor': vendor, 'product': product, 'results': cache[query_name]['data']}}

    cache[query_name] = create_cache_entry(vendor, product)

    return {'data': {'vendor': vendor, 'product': product, 'results': cache[query_name]['data']}}


# This function generates a cache entry
def create_cache_entry(vendor, product):
    cache_entry = {}
    cache_entry['timestamp'] = time()
    cache_entry['data'] = GetCVES.request(vendor, product)
    return cache_entry
